<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gi·ªè H√†ng - Th·ªßy S·∫£n Th√°i S∆°n</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="cart.css" />
  </head>
  <body>
    <header>
      <h1>Gi·ªè H√†ng C·ªßa B·∫°n</h1>
    </header>

    <div class="cart-container">
      <h2>Gi·ªè H√†ng</h2>
      <table class="cart-table">
        <thead>
          <tr>
            <th>S·∫£n ph·∫©m</th>
            <th>Gi√°</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>T·ªïng ph·ª•</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="cart-items">
          <!-- Cart items will be loaded here by JavaScript -->
        </tbody>
      </table>
      <div class="cart-summary">
        <div>T·ªïng ti·ªÅn: <span id="cart-total">0ƒë</span></div>
      </div>
      <div class="cart-actions">
        <button
          class="btn-continue"
          onclick="window.location.href='webthuysanthaison.html'"
        >
          Ti·∫øp t·ª•c mua s·∫Øm
        </button>
        <button class="btn-checkout">Thanh to√°n</button>
      </div>
    </div>

    <footer>
      <h3>Li√™n h·ªá v·ªõi ch√∫ng t√¥i</h3>
      <p>üìç S·ªë 123, ƒë∆∞·ªùng Bi·ªÉn C·∫£, Qu·∫≠n 7, TP.HCM</p>
      <p>üì± 0909 xxx xxx | üìß thaisson@thuysan.vn</p>
      <p>üåê www.thaissonthuysan.vn</p>
    </footer>

    <script>
      const dummyCartItems = [];

      let cartItems =
        JSON.parse(localStorage.getItem("shoppingCart")) || dummyCartItems;
      const cartItemsContainer = document.getElementById("cart-items");
      const cartTotalSpan = document.getElementById("cart-total");

      /**
       * Renders all items currently in the cart.
       */
      function renderCart() {
        cartItemsContainer.innerHTML = ""; // Clear current items
        let total = 0;

        if (cartItems.length === 0) {
          cartItemsContainer.innerHTML =
            '<tr><td colspan="5" style="text-align: center; padding: 30px;">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</td></tr>';
        } else {
          cartItems.forEach((item) => {
            const subtotal = item.price * item.quantity;
            total += subtotal;

            const row = document.createElement("tr");
            row.innerHTML = `
                        <td data-label="S·∫£n ph·∫©m">
                            <div class="cart-item">
                                <img src="${item.img}" alt="${
              item.name
            }" onerror="this.onerror=null;this.src='https://placehold.co/80x80/cccccc/333333?text=Image+Not+Found';">
                                <div class="cart-item-info">
                                    <strong>${item.name}</strong>
                                    <span>${formatCurrency(
                                      item.price
                                    )}/kg</span>
                                </div>
                            </div>
                        </td>
                        <td data-label="Gi√°">${formatCurrency(item.price)}</td>
                        <td data-label="S·ªë l∆∞·ª£ng">
                            <div class="quantity-controls">
                                <button data-id="${
                                  item.id
                                }" data-action="decrease">-</button>
                                <span>${item.quantity}</span>
                                <button data-id="${
                                  item.id
                                }" data-action="increase">+</button>
                            </div>
                        </td>
                        <td data-label="T·ªïng ph·ª•">${formatCurrency(
                          subtotal
                        )}</td>
                        <td class="remove-item">
                            <button data-id="${
                              item.id
                            }" data-action="remove">X√≥a</button>
                        </td>
                    `;
            cartItemsContainer.appendChild(row);
          });
        }
        cartTotalSpan.textContent = formatCurrency(total);
        updateLocalStorage(); // Update local storage after rendering
      }

      /**
       * Handles quantity changes and item removal.
       * @param {Event} event - The click event.
       */
      function handleCartAction(event) {
        const button = event.target.closest("button");
        if (!button) return;

        const itemId = button.dataset.id; // Kh√¥ng d√πng parseInt
        const action = button.dataset.action;

        const itemIndex = cartItems.findIndex((item) => item.id == itemId);

        if (itemIndex > -1) {
          if (action === "increase") {
            cartItems[itemIndex].quantity++;
          } else if (action === "decrease") {
            if (cartItems[itemIndex].quantity > 1) {
              cartItems[itemIndex].quantity--;
            } else {
              // N·∫øu s·ªë l∆∞·ª£ng l√† 1 v√† gi·∫£m, x√≥a lu√¥n s·∫£n ph·∫©m
              cartItems.splice(itemIndex, 1);
            }
          } else if (action === "remove") {
            cartItems.splice(itemIndex, 1); // X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè
          }
          renderCart();
        }
      }
      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
          minimumFractionDigits: 0,
        }).format(amount);
      }

      /**
       * Updates the shopping cart data in localStorage.
       */
      function updateLocalStorage() {
        localStorage.setItem("shoppingCart", JSON.stringify(cartItems));
      }
      cartItemsContainer.addEventListener("click", handleCartAction);
      window.onload = renderCart;

      // X·ª≠ l√Ω n√∫t "Thanh to√°n"
      document
        .querySelector(".btn-checkout")
        .addEventListener("click", function () {
          // Gi·∫£ s·ª≠ user_id l√† 'U001' (b·∫°n c√≥ th·ªÉ l·∫•y t·ª´ ƒëƒÉng nh·∫≠p th·ª±c t·∫ø)
          const user_id = localStorage.getItem("user_id") || "U001";
          if (cartItems.length === 0) {
            alert("Gi·ªè h√†ng tr·ªëng!");
            return;
          }
          fetch("place-order.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              user_id: user_id,
              cart: cartItems,
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
                cartItems = [];
                updateLocalStorage();
                renderCart();
              } else {
                alert("ƒê·∫∑t h√†ng th·∫•t b·∫°i: " + data.message);
              }
            })
            .catch(() => {
              alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi server!");
            });
        });
    </script>
  </body>
</html>
